# SNS Club Portal - 動画管理システム 仕様書

## 概要

Zoom録画完了をトリガーに、サムネ生成→YouTubeアップ→Discord通知→Notion更新を全自動化するシステム。

---

## システム構成図

```
講師: Zoom後にNotionマスターテーブルへ入力
         │
         ▼
Zoom録画完了 → Webhook
         │
         ▼
   自動化サーバー
   ┌──────────────────────────────────┐
   │ ① Zoom録画ダウンロード            │
   │ ② マスターテーブルと±30分照合      │
   │ ③ Nano Banana Pro（Gemini）で     │
   │    サムネ生成                      │
   │    (参考イメージ+タイトル文言)      │
   │ ④ YouTubeに限定公開アップ          │
   │ ⑤ Discordに通知投稿               │
   │ ⑥ Notion動画DB更新                │
   │ ※ エラー時→テーブルに記録          │
   └──────────────────────────────────┘
         │
         ▼
   Notionポータル（公開ページ）
         │
         ▼
   受講生がリンクからYouTubeで視聴
```

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| マスターデータ / 動画DB / ポータル | Notion |
| サムネ生成 | Nano Banana Pro（`gemini-3-pro-image-preview`） |
| 動画ホスティング | YouTube（限定公開） |
| 通知 | Discord Webhook（共通1チャンネル） |
| トリガー | Zoom Webhook |
| 自動化サーバー | GitHub Actions |

---

## 動画種別

| 種別 | 説明 |
|------|------|
| 1on1添削 | Zoomで1on1実施 → 録画 |
| グループコンサル | グループコンサルの録画 |
| マネタイズ講座 | マネタイズ講座の録画 |

---

## サムネ生成方式

### 使用サービス

Nano Banana Pro（モデルID: `gemini-3-pro-image-preview`）を使用したAI画像生成。

### アプローチ

テンプレートベース：参考イメージ + タイトル文言で毎回新規生成。

### レイアウトパターン

| パターン | 構成 | 用途 |
|---------|------|------|
| パターンA（1人） | スマートフォン画面に講師1名 | 1on1添削など |
| パターンB（2人） | 丸枠×2に講師2名（×マーク付き） | グルコン・講座など |

### サムネ構成要素

| 区分 | 要素 | 説明 |
|------|------|------|
| 動的 | サムネ文言 | 中央テキスト |
| 動的 | 講師画像 | 1〜2名分（`assets/lecturer-images/` に格納） |
| 動的 | 講師名 | GUEST表示 |
| 動的 | ジャンル | GENRE表示 |
| 静的 | 背景デザイン | テンプレート固定 |
| 静的 | レイアウト構成 | テンプレート固定 |
| 静的 | 装飾 | テンプレート固定 |

---

## 講師一覧

| # | 講師名 | 画像パス |
|---|--------|---------|
| 1 | 陸 | `assets/lecturer-images/` |
| 2 | たっちー | `assets/lecturer-images/` |
| 3 | しゅうへい | `assets/lecturer-images/` |
| 4 | はなこ | `assets/lecturer-images/` |
| 5 | ちゃみ | `assets/lecturer-images/` |
| 6 | かりん | `assets/lecturer-images/` |
| 7 | じゅん | `assets/lecturer-images/` |
| 8 | みくぽん | `assets/lecturer-images/` |

※ 後日変更の可能性あり

---

## Notionテーブル設計

### マスターテーブル（講師入力用）

| 列名 | 型 | 入力 | 説明 | サムネ要素 |
|------|-----|------|------|:---------:|
| タイトル | title | 手動 | YouTube・ポータル表示用 | - |
| サムネ文言 | rich_text | 手動 | サムネ中央のテキスト | B |
| 種別 | select | 手動 | 1on1 / グルコン / 講座 | - |
| 開始時間 | date | 手動 | Zoom開始時間の目安（±30分で照合） | - |
| 講師名 | rich_text | 手動 | GUEST表示名（例: 陸講師×はなこ講師） | E |
| 講師画像1 | files | 手動 | サムネ左側の丸枠画像（`assets/lecturer-images/` から参照） | C |
| 講師画像2 | files | 手動 | サムネ右側の丸枠画像（`assets/lecturer-images/` から参照） | D |
| ジャンル | select | 手動 | GENRE表示（例: アフィリエイト） | F |
| ステータス | select | 自動 | 入力済み / 処理中 / 完了 / エラー / 要手動対応 | - |
| エラー内容 | rich_text | 自動 | エラー時の詳細 | - |
| リトライ回数 | number | 自動 | 上限3回 | - |
| YouTubeリンク | url | 自動 | 完了後に自動記入 | - |
| 処理日時 | date | 自動 | 処理実行日時 | - |

### 動画DB（ポータル表示用）

| 列名 | 型 |
|------|-----|
| タイトル | title |
| 種別 | select |
| 日付 | date |
| 講師名 | select |
| YouTubeリンク | url |
| サムネイル | files |

→ Gallery Viewで表示。Linked Databaseでカテゴリごとにフィルタ。

---

## 自動化フロー

### 正常系

```
Zoom録画完了（Webhook受信）
  ↓
エラーレコード（ステータス=エラー）があればリトライ
  ↓
Zoom start_time でマスターテーブルを±30分検索
  ↓ マッチ成功
ステータス →「処理中」
  ↓
Nano Banana Pro → 参考イメージ + サムネ文言でサムネ生成
  ↓
YouTube Data API → 動画+サムネを限定公開アップロード
  ↓
Discord Webhook → 共通チャンネルに通知
  ↓
Notion API → 動画DBにレコード追加（YouTubeリンク含む）
  ↓
Notion API → マスターテーブルにYouTubeリンクを記録 + ステータス「完了」に更新
  ↓
ポータルに自動反映 → 受講生がYouTubeで視聴
```

### エラー系

| 方針 | 内容 |
|------|------|
| フォールバック | エラー発生時は処理中断し安全に停止 |
| エラー記録 | マスターテーブルにステータス「エラー」+エラー内容を記入 |
| リトライ | 次回Webhook受信時に自動リトライ（上限3回） |
| 上限超過 | ステータスを「要手動対応」に変更 |

| エラーパターン | 対応 |
|--------------|------|
| Zoom録画DL失敗 | リトライ |
| マッチ失敗 | エラー記録→リトライ |
| サムネ生成失敗 | リトライ |
| YouTube Upload失敗 | リトライ |
| Discord通知失敗 | スキップして続行 |
| Notion更新失敗 | 外部ログに記録 |

---

## Discord通知仕様

### 通知タイミング

YouTube限定公開アップロード完了後、Discord Webhookにリッチ Embed を送信する。

### 通知内容

| 項目 | Embed要素 | 値 |
|------|----------|-----|
| タイトル | title | 「🎬 新しい動画がアップロードされました」 |
| 説明 | description | Notionマスターテーブルのタイトル |
| リンク | url | YouTubeリンク |
| サムネイル画像 | image | YouTube自動生成URL（`https://i.ytimg.com/vi/{video_id}/maxresdefault.jpg`） |
| 色 | color | `#58ACFF`（ブランドブルー） |

### Embedフィールド（講師入力内容）

| フィールド名 | 値の出所 | inline |
|-------------|---------|:------:|
| 講師 | マスターテーブル: 講師名 | ✓ |
| 種別 | マスターテーブル: 種別 | ✓ |
| ジャンル | マスターテーブル: ジャンル | ✓ |
| サムネ文言 | マスターテーブル: サムネ文言 | ✗ |
| 生徒名 | マスターテーブル: 生徒名（1on1時のみ） | ✓ |
| YouTube | YouTubeリンク | ✗ |
| Notion | Notionマスターページリンク（`https://notion.so/{page_id}`） | ✗ |

### エラー時の挙動

Discord通知失敗はパイプラインを中断しない（ログ記録のみ）。

---

## ポータル構成

```
SNS Club Portal（Notion公開ページ）
├── 1on1添削動画 一覧
├── グループコンサル動画 一覧
└── マネタイズ講座動画 一覧
```

各カード表示：サムネイル / タイトル / 日付 / YouTubeリンク

---

## 必要なAPIキー

| サービス | 必要なもの | 状態 |
|---------|----------|:----:|
| Zoom | Account ID + Client ID/Secret | 済 |
| YouTube | OAuth 2.0 (Client ID/Secret + Refresh Token) | 済 |
| Notion | Integration Token | 済 |
| Nano Banana Pro | Gemini API Key | 済 |
| Discord | Webhook URL | 保留 |

---

## 講師入力Webフォーム（即時パイプライン実行）

### 概要

講師がテンプレート画像・講師画像をビジュアルで選択しながら入力できる外部Webフォーム。
フォーム送信時にフルパイプラインが即時実行される。

### 起動方法

```bash
pip install flask
python web/app.py
# http://localhost:8080 で起動
```

### フォーム入力項目

| フィールド | UI部品 | 必須 | パターン依存 |
|-----------|--------|:----:|:----------:|
| テンプレートパターン | 画像ドロップダウン | ○ | - |
| タイトル | text input | ○ | - |
| サムネ文言 | textarea | ○ | - |
| 種別 | select (1on1/グルコン/講座) | ○ | - |
| 開始時間 | datetime-local | ○ | - |
| 動画ファイル (MP4) | ファイルアップロード | ○ | - |
| 講師名 | text input | - | パターン1,2,3 |
| 講師画像（左） | 画像ドロップダウン | - | パターン1のみ |
| 講師画像（右） | 画像ドロップダウン | - | パターン1のみ |
| 講師画像 | 画像ドロップダウン | - | パターン2のみ |
| 生徒名 | text input | - | パターン3のみ |
| 補足情報 | textarea | - | - |

### パターン別フィールド切替

| パターン | 表示フィールド |
|---------|--------------|
| パターン1（対談） | 講師名 + 講師画像（左）+ 講師画像（右） |
| パターン2（グルコン） | 講師名 + 講師画像 |
| パターン3（1on1） | 講師名 + 生徒名（テキストのみ） |

### フォーム送信時の即時実行パイプライン

```
講師がWebフォームで入力 + 動画ファイルをアップロード
  ↓
POST /submit
  ↓
① Notion マスターレコード作成（ステータス = "入力済み"）
  ↓
② ステータス → "処理中"
  ↓
③ 動画ファイルを一時保存
  ↓
④ Nano Banana Pro（Gemini）でサムネイル生成
  ↓
⑤ YouTube Data API で動画 + サムネを限定公開アップロード
  ↓
⑥ Discord Webhook で通知投稿
  ↓
⑦ Notion 動画アーカイブDBにレコード作成
  ↓
⑧ マスターレコード ステータス → "完了" + YouTubeリンク記入
  ↓
完了画面表示（YouTube・Notionリンク + サムネプレビュー）
```

### エラー時の挙動

- エラー発生時はNotionマスターレコードをステータス「エラー」に更新
- エラー内容をNotionに記録
- ブラウザにはエラーメッセージを表示
- Discord通知失敗はスキップ（パイプラインは続行）

### ファイル構成

```
web/
├── app.py                  # Flask本体（パイプライン実行含む）
├── static/
│   ├── css/style.css       # モバイルファーストCSS
│   └── js/form.js          # パターン切替・ファイルアップロードUI
└── templates/
    ├── form.html           # 入力フォーム（画像ドロップダウン）
    └── success.html        # 完了画面（YouTube・Notionリンク）
```

---

## 確定事項・前提条件

| # | 項目 | 決定内容 |
|---|------|---------|
| 1 | YouTubeチャンネル | 1チャンネルのみ（SnsCool AI） |
| 2 | Zoom重複 | なし（スマートアカウント運用のため同時間帯の重複なし） |
| 3 | 過去動画 | 移行不要（新規動画のみ対象） |
| 4 | 自動化基盤 | GitHub Actions |
| 5 | サムネ生成 | Nano Banana Pro（`gemini-3-pro-image-preview`） |
| 6 | 講師人数 | 8名（陸、たっちー、しゅうへい、はなこ、ちゃみ、かりん、じゅん、みくぽん）※後日変更の可能性あり |

## 未確定事項

| # | 項目 |
|---|------|
| 1 | Nano Banana Pro の料金プラン確認（1K/2K: $0.134/枚、4K: $0.24/枚） |
| 2 | Notion編集権限を持つ講師の人数 |

---

## 開発フェーズ

| Phase | 内容 |
|-------|------|
| 1 | Notionテーブル設計 + ポータル構築 + Webhook受信サーバー |
| 2 | 自動化パイプライン（Zoom→Nano Banana Pro→YouTube→Discord→Notion） |
| 3 | エラーハンドリング + リトライ機構 |
| 4 | E2Eテスト + 運用開始 |
