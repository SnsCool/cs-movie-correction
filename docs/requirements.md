# SNS Club Portal - 要件定義書

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | SNS Club Portal 動画管理システム |
| プロジェクトオーナー | SNS Club 運営 |
| 対象システム | Zoom録画 → サムネ生成 → YouTube公開 → Discord通知 → Notion更新の全自動化 |
| 開発リポジトリ | https://github.com/SnsCool/cs-movie-correction |

---

## 2. 背景・目的

### 2.1 背景

SNS Club では講師が受講生に対して1on1添削、グループコンサル、マネタイズ講座などをZoomで実施しており、録画をアーカイブとして受講生に提供している。現状、録画後の以下の作業をすべて手動で行っており、運用負荷が高い。

- Zoom録画のダウンロード
- サムネイル画像の作成（デザインツールで手作業）
- YouTubeへの限定公開アップロード
- Discord への通知投稿
- Notion ポータルへの動画情報登録

### 2.2 目的

上記の手動作業をすべて自動化し、講師はWebフォームで動画情報を入力するだけで、Zoom録画完了後に全工程が自動実行される仕組みを構築する。

### 2.3 期待効果

| 効果 | 内容 |
|------|------|
| 工数削減 | 録画1件あたり約30分の手作業 → 入力3分のみ |
| 品質統一 | AI生成によるサムネイルデザインの統一 |
| 即時性 | 録画完了から数分で受講生に公開 |
| ヒューマンエラー防止 | リンク貼り間違い、通知忘れ等の排除 |

---

## 3. ステークホルダー

| 役割 | 対象者 | システムとの関わり |
|------|--------|------------------|
| 講師 | 陸、たっちー、しゅうへい、はなこ、ちゃみ、かりん、じゅん、みくぽん（計8名） | Webフォームで動画情報を入力 |
| 受講生 | SNS Club会員 | Notionポータルから動画を視聴 |
| 運営 | システム管理者 | システム監視・エラー対応 |

---

## 4. スコープ

### 4.1 スコープ内

| # | 機能 |
|---|------|
| 1 | 講師入力用Webフォーム |
| 2 | Zoom録画の自動ダウンロード |
| 3 | 録画動画の無音トリミング（冒頭・末尾） |
| 4 | AIサムネイル自動生成（Gemini） |
| 5 | YouTube限定公開アップロード |
| 6 | Discord通知投稿 |
| 7 | Notion動画アーカイブDB更新 |
| 8 | Notionマスターテーブルのステータス管理 |
| 9 | エラー時の自動リトライ（上限3回） |
| 10 | Notionポータル（Gallery View）での動画公開 |

### 4.2 スコープ外

| # | 対象外機能 | 理由 |
|---|----------|------|
| 1 | 過去動画の移行 | 新規動画のみ対象 |
| 2 | 動画編集（カット・テロップ等） | 無音トリミングのみ |
| 3 | 受講生の認証・アクセス制御 | Notion公開ページ + YouTube限定公開で代替 |
| 4 | 課金・決済機能 | 別システムで管理 |
| 5 | 複数Zoomアカウント対応 | スマートアカウント運用で同時間帯の重複なし |

---

## 5. 動画種別

| # | 種別 | 説明 | サムネパターン |
|---|------|------|-------------|
| 1 | 1on1添削 | 講師と受講生の1対1Zoom録画 | パターン3（テキストのみ） |
| 2 | グループコンサル | 複数受講生参加のグルコン録画 | パターン2（スマホ画面） |
| 3 | 講師対談 | 講師同士の対談録画 | パターン1（2人丸枠） |
| 4 | マネタイズ講座 | マネタイズに関する講座録画 | パターン1 or 2 |

---

## 6. 機能要件

### FR-01: 講師入力Webフォーム

| 要件ID | 要件 |
|--------|------|
| FR-01-01 | 講師がブラウザからアクセスできるWebフォームを提供する |
| FR-01-02 | テンプレートパターンを画像プレビュー付きドロップダウンで選択できる |
| FR-01-03 | 講師画像を丸型アイコンのビジュアルピッカーで選択できる |
| FR-01-04 | 選択したパターンに応じて入力フィールドが動的に切り替わる |
| FR-01-05 | 必須項目: テンプレートパターン、タイトル、サムネ文言、種別、開始時間 |
| FR-01-06 | モバイルファーストのレスポンシブデザインとする |
| FR-01-07 | フォーム送信時にNotionマスターテーブルにレコードを作成する |
| FR-01-08 | 送信完了画面にNotionページへのリンクを表示する |
| FR-01-09 | CSRF対策を実装する |
| FR-01-10 | 入力値のバリデーション（文字数上限500文字、必須チェック）を行う |

### FR-02: Zoom録画ダウンロード

| 要件ID | 要件 |
|--------|------|
| FR-02-01 | Zoom Server-to-Server OAuth で認証する |
| FR-02-02 | 直近24時間のクラウド録画一覧を取得する |
| FR-02-03 | 対象録画タイプ: `shared_screen_with_speaker_view`、`shared_screen_with_speaker_view(CC)`、`active_speaker` |
| FR-02-04 | レジューマブルダウンロードでリトライに対応する |

### FR-03: 無音トリミング

| 要件ID | 要件 |
|--------|------|
| FR-03-01 | FFmpegを使用して録画の冒頭・末尾の無音区間を自動検出する |
| FR-03-02 | 無音検出の閾値は -40dB とする |
| FR-03-03 | 冒頭の無音（受講生待ち時間）をトリミングする |
| FR-03-04 | 末尾の無音（録画停止忘れ）をトリミングする |
| FR-03-05 | 出力形式はMP4とする |

### FR-04: サムネイル自動生成

| 要件ID | 要件 |
|--------|------|
| FR-04-01 | Gemini API（`gemini-3-pro-image-preview`）を使用してサムネイルを生成する |
| FR-04-02 | テンプレートベース方式（ベース画像 + テキスト差し替え + 画像差し替え）で生成する |
| FR-04-03 | 3つのレイアウトパターンに対応する |
| FR-04-04 | パターン1（対談）: 丸枠×2 + テキスト3箇所 + 右丸枠画像差し替え |
| FR-04-05 | パターン2（グルコン）: スマホ画面（下部45%埋没）+ テキスト3箇所 + スマホ画面差し替え |
| FR-04-06 | パターン3（1on1）: テキストのみ（講師名、サムネ文言、生徒名）、画像差し替えなし |
| FR-04-07 | Thinking mode を有効にして生成する |
| FR-04-08 | IMAGE_SAFETY フィルターでブロックされた場合はリトライする |

### FR-05: YouTubeアップロード

| 要件ID | 要件 |
|--------|------|
| FR-05-01 | YouTube Data API v3 を使用する |
| FR-05-02 | OAuth 2.0 リフレッシュトークンで認証する |
| FR-05-03 | 動画を「限定公開（unlisted）」でアップロードする |
| FR-05-04 | レジューマブルアップロード（10MBチャンク）に対応する |
| FR-05-05 | 生成したサムネイルをカスタムサムネイルとして設定する |
| FR-05-06 | アップロード先はSnsCool AIチャンネル（1チャンネルのみ） |

### FR-06: Discord通知

| 要件ID | 要件 |
|--------|------|
| FR-06-01 | Discord Webhook を使用して共通1チャンネルに通知する |
| FR-06-02 | リッチEmbed形式で通知する（タイトル、説明、サムネイル画像、色: #58ACFF） |
| FR-06-03 | Embedフィールド: 講師名、種別、ジャンル、サムネ文言、YouTubeリンク、Notionリンク |
| FR-06-04 | Discord通知失敗時はパイプラインを中断せずログ記録のみとする |

### FR-07: Notion動画DB更新

| 要件ID | 要件 |
|--------|------|
| FR-07-01 | 動画アーカイブDBに新規レコードを作成する |
| FR-07-02 | レコードにYouTube動画のEmbed Blockを含める |
| FR-07-03 | カバー画像にサムネイルを設定する（Gallery View表示用） |
| FR-07-04 | タグ（multi_select）でジャンル分類する: グループコンサル / 1on1 / 講師対談 |
| FR-07-05 | Gallery View + タグでグループ化して表示する |

### FR-08: ステータス管理・エラーハンドリング

| 要件ID | 要件 |
|--------|------|
| FR-08-01 | マスターテーブルのステータスを遷移させる: 入力済み → 処理中 → 完了 |
| FR-08-02 | エラー発生時はステータスを「エラー」に更新しエラー内容を記録する |
| FR-08-03 | エラーレコードは次回トリガー時に自動リトライする（上限3回） |
| FR-08-04 | リトライ上限超過時はステータスを「要手動対応」に変更する |
| FR-08-05 | 完了時にYouTubeリンクをマスターテーブルに記入する |

### FR-09: マッチング

| 要件ID | 要件 |
|--------|------|
| FR-09-01 | Zoom録画の start_time とマスターテーブルの開始時間を±30分の範囲で照合する |
| FR-09-02 | マッチ成功時のみパイプラインを実行する |
| FR-09-03 | マッチ失敗時はエラーとして記録しリトライ対象とする |

---

## 7. 非機能要件

### NFR-01: 可用性

| 要件ID | 要件 |
|--------|------|
| NFR-01-01 | GitHub Actions による定期実行（6時間ごと）で稼働する |
| NFR-01-02 | 手動実行（workflow_dispatch）にも対応する |
| NFR-01-03 | Webフォームは Railway 上で常時稼働する |

### NFR-02: パフォーマンス

| 要件ID | 要件 |
|--------|------|
| NFR-02-01 | 1件の動画処理を10分以内に完了する（Webフォーム timeout: 600秒） |
| NFR-02-02 | YouTubeアップロードはレジューマブル方式で大容量動画に対応する |
| NFR-02-03 | Gunicorn 2 workers で同時リクエストに対応する |

### NFR-03: セキュリティ

| 要件ID | 要件 |
|--------|------|
| NFR-03-01 | APIキーは環境変数で管理し、ソースコードに含めない |
| NFR-03-02 | .env ファイルは .gitignore で管理外とする |
| NFR-03-03 | GitHub Secrets で CI/CD 環境のキーを管理する |
| NFR-03-04 | WebフォームにCSRF対策を実装する |
| NFR-03-05 | セッションCookieに Secure, HttpOnly, SameSite=Lax を設定する |
| NFR-03-06 | YouTube動画は限定公開（URLを知っている人のみ視聴可）とする |

### NFR-04: 運用・保守

| 要件ID | 要件 |
|--------|------|
| NFR-04-01 | エラー発生時はNotionマスターテーブルにエラー内容を記録する |
| NFR-04-02 | Python logging モジュールで処理ログを出力する |
| NFR-04-03 | 講師の追加・削除は `assets/lecturer-images/` への画像追加で対応できる |

### NFR-05: 拡張性

| 要件ID | 要件 |
|--------|------|
| NFR-05-01 | サムネイルテンプレートの追加は `templates/pattern{N}/` を追加するだけで対応できる |
| NFR-05-02 | 各モジュール（zoom, thumbnail, youtube, notion, discord, trim）は独立して差し替え可能な設計とする |

---

## 8. 外部システム連携

| # | 外部システム | 用途 | 認証方式 | 状態 |
|---|------------|------|---------|:----:|
| 1 | Zoom | 録画ダウンロード | Server-to-Server OAuth | 設定済 |
| 2 | YouTube Data API v3 | 動画アップロード | OAuth 2.0 Refresh Token | 設定済 |
| 3 | Notion API | DB読み書き | Integration Token (Bearer) | 設定済 |
| 4 | Gemini API | サムネイル生成 | API Key | 設定済 |
| 5 | Discord | 通知投稿 | Webhook URL | **未設定** |

---

## 9. 画面一覧

| # | 画面名 | URL | 説明 |
|---|--------|-----|------|
| 1 | 動画情報入力フォーム | `/` | 講師がテンプレート・講師画像を選択して動画情報を入力 |
| 2 | 入力完了画面 | `/submit` (POST後) | 送信結果表示（成功: Notionリンク / エラー: エラーメッセージ） |
| 3 | Notionポータル | Notion公開ページ | 受講生が動画一覧をGallery Viewで閲覧 |

---

## 10. データ要件

### 10.1 マスターテーブル（入力データ）

| 項目 | 型 | 必須 | 入力元 | 最大長 |
|------|-----|:----:|-------|--------|
| タイトル | title | ○ | 講師 | 500文字 |
| サムネ文言 | rich_text | ○ | 講師 | 500文字 |
| 種別 | select | ○ | 講師 | 固定値: 1on1/グルコン/講座 |
| 開始時間 | date | ○ | 講師 | ISO 8601 |
| 講師名 | rich_text | - | 講師 | 500文字 |
| 講師画像① | select | - | 講師 | ファイル名 |
| 講師画像② | select | - | 講師 | ファイル名 |
| パターン | select | - | 講師 | パターン1/2/3 |
| 生徒名 | rich_text | - | 講師 | 500文字 |
| 補足情報 | rich_text | - | 講師 | 500文字 |
| ステータス | select | ○ | 自動 | 入力済み/処理中/完了/エラー/要手動対応 |
| エラー内容 | rich_text | - | 自動 | - |
| リトライ回数 | number | - | 自動 | 0〜3 |
| YouTubeリンク | url | - | 自動 | URL |
| 処理日時 | date | - | 自動 | ISO 8601 |

### 10.2 動画アーカイブDB（出力データ）

| 項目 | 型 | 入力元 | 説明 |
|------|-----|-------|------|
| 動画タイトル | title | パイプライン | 表示名 |
| タグ | multi_select | パイプライン | グループコンサル/1on1/講師対談 |
| 日付 | date | パイプライン | 録画日 |
| 講師名 | select | パイプライン | 講師名 |
| YouTubeリンク | url | パイプライン | 限定公開URL |
| サムネイル | files | パイプライン | サムネイル画像ファイル |

---

## 11. 制約条件

| # | 制約 | 内容 |
|---|------|------|
| 1 | YouTubeチャンネル | 1チャンネルのみ（SnsCool AI） |
| 2 | Zoom同時録画 | なし（スマートアカウント運用） |
| 3 | YouTube API制限 | 10,000 units/日（動画アップロード = 1,600 units） |
| 4 | Notion API制限 | 3リクエスト/秒 |
| 5 | サムネ生成モデル | Gemini `gemini-3-pro-image-preview` 固定 |
| 6 | 動画形式 | MP4のみ |
| 7 | 実行環境 | GitHub Actions（ubuntu-latest, Python 3.11） |

---

## 12. 前提条件

| # | 前提 |
|---|------|
| 1 | 講師がZoom録画前にWebフォームから動画情報を入力済みであること |
| 2 | Zoomクラウド録画が有効であること |
| 3 | YouTubeチャンネルが認証済みであること（カスタムサムネイル設定可能） |
| 4 | Notion Integrationが対象DBに接続済みであること |
| 5 | 各APIキーが有効であること |
| 6 | 講師画像が `assets/lecturer-images/` に格納済みであること |
| 7 | サムネイルテンプレートが `templates/pattern{N}/` に格納済みであること |

---

## 13. 用語定義

| 用語 | 定義 |
|------|------|
| マスターテーブル | 講師が入力し、パイプラインが処理するNotionのDB。サムネイル生成マスター。 |
| 動画アーカイブDB | パイプライン処理完了後に受講生向けに公開されるNotionのDB |
| パイプライン | Zoom録画DL → トリミング → サムネ生成 → YouTube UP → Discord通知 → Notion更新 の一連の自動処理 |
| Nano Banana Pro | Gemini API を使用したサムネイル生成サービスの呼称 |
| Gallery View | Notion DBをカード型で表示するビュー。サムネイルが一覧表示される |
| 限定公開 | YouTube の公開設定。URLを知っている人のみ視聴可能 |
| パターン1 | 対談用サムネイル。丸枠×2で講師2名を表示 |
| パターン2 | グルコン用サムネイル。スマホ画面を下部45%埋没で表示 |
| パターン3 | 1on1用サムネイル。テキストのみで画像差し替えなし |

---

## 14. 確定事項・未確定事項

### 確定事項

| # | 項目 | 決定内容 |
|---|------|---------|
| 1 | YouTubeチャンネル | SnsCool AI（1チャンネル） |
| 2 | Zoom重複 | なし |
| 3 | 過去動画移行 | 不要 |
| 4 | 自動化基盤 | GitHub Actions |
| 5 | サムネ生成 | Gemini API |
| 6 | 講師人数 | 8名（変更可能性あり） |
| 7 | Webフォーム | Railway にデプロイ |
| 8 | ポータル | Notion公開ページ |

### 未確定事項

| # | 項目 | 備考 |
|---|------|------|
| 1 | Discord Webhook URL | 運営から提供待ち |
| 2 | Zoom Webhook Secret | Zoom Marketplace で設定が必要 |
| 3 | Gemini API 料金プラン | 1K/2K: $0.134/枚、4K: $0.24/枚 |
| 4 | Notion編集権限の講師数 | 運営確認待ち |

---

## 15. 開発フェーズ

| Phase | 内容 | 状態 |
|-------|------|:----:|
| 1 | Notionテーブル設計 + ポータル構築 | 完了 |
| 2 | 自動化パイプライン（Zoom → Gemini → YouTube → Discord → Notion） | 完了 |
| 3 | 講師入力Webフォーム + Railway デプロイ | 完了 |
| 4 | エラーハンドリング + リトライ機構 | 完了 |
| 5 | E2Eテスト + 運用開始 | **進行中** |

---

## 改訂履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2026-02-22 | 1.0 | 初版作成 |
